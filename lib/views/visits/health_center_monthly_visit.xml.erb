<?xml version="1.0" encoding="UTF-8"?>
<olmis>
  <meta>
    <date><%= [Date.today, @visit.updated_at, @visit.created_at].compact.max.to_date.to_s %></date>
    <province><%= @visit.health_center && @visit.health_center.province.name %></province>
    <district><%= @visit.health_center && @visit.health_center.district.name %></district>
    <delivery_zone><%= @visit.health_center && @visit.health_center.delivery_zone.name %></delivery_zone>
    <field_coordinator><%= @visit.field_coordinator_name %></field_coordinator>
  </meta>
  <hcvisit>
    <health_center><%= @visit.health_center && @visit.health_center.name %></health_center>
    <epi_month><%= @visit.epi_month %></epi_month>
    <visited><%= @visit.visited? %></visited>
    <epi_data_ready><%= @visit.epi_data_ready? %></epi_data_ready>
    <visited_at><%= @visit.visited_at %></visited_at>
    <visit_month><%= @visit.date_period %></visit_month>
    <vehicle_id><%= @visit.vehicle_code %></vehicle_id>
    <non_visit_reason><%= @visit.visit_status %></non_visit_reason>
    <notes><%= @visit.notes %></notes>
    <epi>
    <%- HealthCenterVisit.tally_hash.map{|k,v| k.constantize}.each do |klass| -%>
      <<%= klass.name.tableize %>>
        <%- record_value_hash = klass.records_by_param_names_for_keys(@visit.health_center, @visit.epi_month) -%>
        <%- klass.expected_params().each do |param, type| -%>
          <item for="<%= param %>"
            <%- if r = record_value_hash[param] -%>
              <%- value = r.send(klass.value_field(param)) -%>
              nr="<%= value.nil? %>" val="<%= value %>"
            <%- else -%>
              nr="" val=""
            <%- end -%>
           />
        <%- end -%>
      </<%= klass.name.tableize %>>
    <%- end -%>
    </epi>
    <visit>
      <inventory>
        <%- stock = @visit.ideal_stock -%>    
        <%- Package.all.each do |package| -%>
          <%- index = package.code -%>
          <%- Inventory.types.select { |t| package.inventoried_by_type?(t) }.each do |type| -%>
            <%- if stock[type][index] -%>
              <item for="<%= package.code %>" type="<%= type %>" nr="<%= !stock[type][index].new_record? && stock[type][index].quantity.nil? %>" qty="<%= stock[type][index].quantity %>" />
            <%- end -%>
          <%- end -%>
        <%- end -%>
      </inventory>
      <general>
        <%- equipment = @visit.equipment_count_and_status_by_type -%>
        <%- EquipmentType.all.each do |type| -%>
          <item for="<%= type.code %>" nr="<%= !equipment[type].first.new_record? && equipment[type].first.quantity.nil? %>" qty="<%= equipment[type].first.quantity %>" status="<%= equipment[type].last.status_code %>" notes="<%= equipment[type].last.notes %>" />
        <%- end -%>
      </general>
      <cold_chain>
        <fridges>
          <%- @visit.find_or_initialize_fridge_statuses.each do |fs| -%>
            <fridge code="<%= fs.fridge_code %>" nr="<%= !fs.new_record? && fs.temperature.nil? %>" temp="<%= fs.temperature %>" status="<%= fs.status_code %>" notes="<%= fs.notes %>" />
          <%- end -%>
        </fridges>
      </cold_chain>
      <stock_cards>
        <%- StockCard.all.each do |type| -%>
          <item for="<%= type.code %>" have="" use="" />
        <%- end -%>
      </stock_cards>
    </visit>
  </hcvisit>
</olmis>
