<div id="fridges"></div>
<%= button_to_function(h(t("data_sources.hcvisit.add_fridge")), "new_fridge()", :id => "add-fridge") %>

<script type="text/html" id="fridge_template">
  {{each(i,fridge) data}}
    <div class="fridge-data">
      <div class="fridge-id">
        <label for="fridge_status_${ i }_fridge_code"><%= jt(t("visits.health_center_cold_chain.fridge_id")) %></label>
        <input id="fridge_status_${ i }_fridge_code" name="fridge_status[${ i }][fridge_code]" type="text" required />
      </div>
      <div class="two-column">
        <div class="fridge-in">
          <div class="fridge-past_problem">
            <div><%= jt(t("visits.health_center_cold_chain.past_problem")) %></div>
            <ul class="radio">
              <%- [ [ jt(t("yes")), "true" ], [ jt(t("no")), "false" ], [ jt(t("unknown")), "nr" ] ].each do |label,value| -%>
                <li>
                  <input id="fridge_status_${ i }_past_problem_<%= value %>" name="fridge_status[${ i }][past_problem]" value="<%= value %>" type="radio" required />
                  <label for="fridge_status_${ i }_past_problem_<%= value %>"><%= label %></label>
                </li>
              <%- end -%>
            </ul>
          </div>
          <div class="fridge-temp">
            <div><%= jt(t("visits.health_center_cold_chain.arrival_temp")) %></div>
            <div>
              <label for="fridge_status_${ i }_temperature"><%= jt(t("visits.health_center_cold_chain.temp_input_prefix")) %></label>
              <input id="fridge_status_${ i }_temperature" name="fridge_status[${ i }][temperature]" type="number" required />
              <span><%= jt(t("visits.health_center_cold_chain.temp_input_suffix")) %></span>
            </div>
          </div>
        </div>
        <div class="fridge-out">
          <div class="fridge-state">
            <div><%= jt(t("visits.health_center_cold_chain.departure_state")) %></div>
            <ul class="radio">
              <%- [ [ jt(t("yes")), "OK" ], [ jt(t("no")), "problem" ], [ jt(t("unknown")), "nr" ] ].each do |label,value| -%>
                <li>
                  <input id="fridge_status_${ i }_state_<%= value %>" name="fridge_status[${ i }][state]"
                    <%- if value == "problem" -%>
                         onclick="$(\'#fridge-problem-${ i }\').show();"
                    <%- else -%>
                         onclick="$(\'#fridge-problem-${ i }\').hide();"
                    <%- end -%>
                         value="<%= value %>" type="radio" required />
                  <label for="fridge_status_${ i }_state_<%= value %>"><%= label %></label>
                </li>
              <%- end -%>
            </ul>
          </div>
          <div id="fridge-problem-${ i }" class="fridge-problem checkbox-group" style="display: none;">
            <div><%= jt(t("visits.health_center_cold_chain.problem")) %></div>
            <ul class="check-list">
              <%- FridgeStatus.not_ok_status_options.each do |label,value| -%>
                <label>  
                  <input id="fridge_status_${ i }_problem_<%= value %>" name="fridge_status[${ i }][problem][]"
                    <%- if value == "OTHER" -%>
                         onclick="$(\'#fridge-other_problem-${ i }\').toggle();"
                    <%- end -%>
                         value="<%= value %>" type="checkbox" />
                  <%= jt(label) %>
                </label>
              <%- end -%>
            </ul>
            <div id="fridge-other_problem-${ i }" class="fridge-other_problem" style="display: none;">
              <textarea id="fridge_status_${ i }_other_problem" name="fridge_status[${ i }][other_problem]"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="clear"></div>
    </div>
  {{/each}}
</script>
<script type="text/javascript">
var new_fridge = function(code) { 
  $.push(olmis_instance.fridge_status, {
    fridge_code:   code || '',     
    past_problem:  '',
    temperature:   '',
    state:         '',
    problem:       [],
    other_problem: ''             
}) };

var refresh_fridges = function() {  
  $("#fridges").empty().append("fridge_template", {data:olmis_instance.fridge_status});
  $('#fridges *:input').blur(serialize_visit);
  $('#fridges *:input').addClass('enabled');
  $('#fridges').setupValidation();
/*
    // bind inputs to the data items
//    $(".contact").each(function(i) {
//        var contact = contacts[i];
//        $(".firstname", this).linkTo("val", contact, "firstName");
//        $(".lastname", this).linkTo("val", contact, "lastName");
//        $(".contact-fullname", this).linkFrom("text", contact, null, "fullname");
//        $(".contact-remove", this).click(function() {
//            $.splice(contacts, i, 1);
//        });
//        $(".phone", this).each(function(i) {
//            var phone = contact.phones[i];
//            $(".phone-type", this).linkTo("val", phone, "type");
//            $(".phone-number", this).linkTo("val", phone, "number", "phone");
//            $(".phone-remove", this).click(function() {
//                // note: I'd like to only redraw the phones portion of the
//                // template, but jquery.tmpl.js does not support nested templates
//                // very easily. So here I am triggering an arrayChange event on
//                // the main contacts array to force the entire thing to refresh.
//                // Note that user input is not lost since the live linking has
//                // already stored the values in the object graph.
//                $.splice(contact.phones, i, 1);
//                $([contacts]).trigger("arrayChange");
//            });
//        });
//        $(".newphone", this).click(function() {
//            $.push(contact.phones, { type: "", number: "" });
//            $([contacts]).trigger("arrayChange");
//        });
//    });
*/
};
    
$(function() { $.templates.fridge_template = $.tmpl($("#fridge_template").html()); });
</script>
